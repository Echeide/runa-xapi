<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Combinación Rúnica - Con XAPI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=MedievalSharp&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    
    <!-- Sistema H5P XAPI -->
    <script src="XAPI_samples/h5p-events.js"></script>
    <script src="XAPI_samples/h5p-xapi-events.js"></script>
    <script src="h5p-xapi-manager.js"></script>
    
    <style>
        html, body {
            height: 100%;
            overflow: hidden; /* Previene el scroll */
            background-color: #2c1f1f;
        }
        body {
            font-family: 'MedievalSharp', cursive;
            background-image: url('https://www.transparenttextures.com/patterns/stone-wall.png');
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .title-font {
            font-family: 'Cinzel', serif;
        }
        .rune-btn, .guess-slot {
            background-color: rgba(10, 5, 5, 0.4);
            border: 2px solid #6b4f4f;
            width: 48px; /* Reducido para encajar mejor */
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
        }
        .rune-btn:hover:not(:disabled) {
            background-color: rgba(60, 40, 40, 0.6);
            border-color: #a18080;
        }
        .rune-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .guess-slot {
             cursor: default;
        }
        .guess-slot.filled {
            border-color: #c5a687;
        }
        .rune-btn svg, .guess-slot svg {
            width: 65%;
            height: 65%;
            stroke: #e0d1b1;
            stroke-width: 1.5;
            transition: stroke 0.2s;
        }
        /* Estilo para las runas reveladas en caso de derrota */
        .revealed-slot {
            background-color: #e0d1b1;
            border-color: #2c1f1f;
        }
        .revealed-slot svg {
            stroke: #2c1f1f;
        }
        .feedback-peg {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.5);
        }
        .peg-correct { background-color: #86efac; }
        .peg-present { background-color: #fde047; }
        .peg-empty { background-color: rgba(0,0,0,0.2); }
        
        /* Animación de temblor para derrota */
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake {
          animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Animación de explosión (flash) */
        @keyframes flash {
          0% { opacity: 1; }
          100% { opacity: 0; }
        }
        .explosion-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: white;
            z-index: 9999;
            animation: flash 0.4s forwards;
            pointer-events: none;
        }

        /* Overlay para la pantalla rota */
        .cracks-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9998; /* Justo debajo del flash */
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .cracks-overlay.visible {
            opacity: 1;
        }
        .cracks-overlay line {
            stroke: rgba(255, 255, 255, 0.7);
            stroke-width: 0.2;
        }


    </style>
</head>
<body class="text-gray-300">


    <div id="cracks-overlay" class="cracks-overlay">
        <svg width="100%" height="100%" preserveAspectRatio="none">
            <line x1="0" y1="0" x2="100%" y2="100%"/>
            <line x1="100%" y1="0" x2="0" y2="100%"/>
            <line x1="50%" y1="0" x2="50%" y2="100%"/>
            <line x1="0" y1="50%" x2="100%" y2="50%"/>
            <line x1="20%" y1="0" x2="80%" y2="100%"/>
            <line x1="80%" y1="0" x2="20%" y2="100%"/>
        </svg>
    </div>

    <div class="container mx-auto p-2 max-w-sm">
        <main class="bg-black bg-opacity-40 p-4 rounded-xl shadow-2xl">
            <!-- Área de Adivinanzas -->
            <div id="guesses-container" class="space-y-2 mb-4">
                <!-- Las filas de adivinanzas se generan aquí -->
            </div>

            <!-- Panel de Runas Disponibles -->
            <div class="mb-4">
                <div id="rune-palette" class="grid grid-cols-6 gap-1">
                    <!-- Las runas para elegir se generan aquí -->
                </div>
            </div>
            
            <!-- Leyenda de Pistas -->
            <div class="text-xs text-gray-400 mb-4 flex items-center justify-center space-x-4">
                <div class="flex items-center space-x-1.5">
                    <div class="feedback-peg peg-correct"></div>
                    <span>Posición Correcta</span>
                </div>
                 <div class="flex items-center space-x-1.5">
                    <div class="feedback-peg peg-present"></div>
                    <span>Runa Correcta</span>
                </div>
            </div>

            <!-- Controles y Mensajes -->
            <div id="controls" class="flex flex-col items-center justify-center">
                 <div class="flex w-full gap-2 mb-3">
                    <button id="clear-btn" class="w-1/2 bg-red-900/70 hover:bg-red-800/70 text-white font-bold py-2 px-4 rounded-lg title-font transition-colors">Limpiar</button>
                    <button id="guess-btn" class="w-1/2 bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-4 rounded-lg title-font transition-colors">Probar</button>
                 </div>
                 <p id="message-area" class="text-base text-center h-5"></p>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Configuración y Constantes ---
    const RUNES = [
        `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2 L12 22 M12 12 L20 4 M12 12 L20 20"></path></svg>`,
        `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M2 12 L22 12 M12 2 L2 12 L12 22"></path></svg>`,
        `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M2 2 L22 2 M2 22 L22 22 M12 2 L12 22"></path></svg>`,
        `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 4 L20 20 M20 4 L4 20"></path></svg>`,
        `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2 L12 22 M12 2 L2 12 M12 2 L22 12"></path></svg>`,
        `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M2 2 L12 12 L2 22 M12 12 L22 2 M12 12 L22 22"></path></svg>`
    ];
    const CODE_LENGTH = 4;
    const MAX_GUESSES = 8;

    // --- Configuración XAPI ---
    const XAPI_CONFIG = {
        endpoint: 'https://192.168.1.35:3600/xapi',
        username: 'routingtales-user',
        password: 'routingtales-pass',
        actor: {
            name: "Usuario RoutingTales",
            mbox: "mailto:usuario@routingtales.com"
        },
        activityId: 'urn:uuid:combinacion-runica-game',
        activityName: 'Combinación Rúnica',
        activityDescription: 'Juego de combinación de runas vikingas'
    };
    
    // Detectar si estamos en un iframe
    const isInIframe = window.parent !== window;
    console.log('🔍 Detectado iframe:', isInIframe);
    
    // Inicializar XAPI Manager solo si no estamos en iframe
    let xapiManager = null;
    if (!isInIframe) {
        try {
            xapiManager = new H5PXAPIManager(XAPI_CONFIG);
            console.log('XAPI Manager inicializado:', XAPI_CONFIG.endpoint);
        } catch (error) {
            console.error('Error inicializando XAPI Manager:', error);
        }
    } else {
        console.log('📡 Ejecutándose en iframe - usando comunicación con sistema padre');
    }

    // --- Efectos de Sonido ---
    const winSound = new Audio();
    const loseSound = new Audio();

    // --- Elementos del DOM ---
    const guessesContainer = document.getElementById('guesses-container');
    const runePalette = document.getElementById('rune-palette');
    const guessBtn = document.getElementById('guess-btn');
    const clearBtn = document.getElementById('clear-btn');
    const messageArea = document.getElementById('message-area');
    const mainContainer = document.querySelector('main');
    const cracksOverlay = document.getElementById('cracks-overlay');

    // --- Variables de Estado del Juego ---
    let secretCode = [], currentGuess = [], currentRowIndex = 0;
    let gameStartTime = null;
    let gameEndTime = null;
    let attemptsCount = 0;

    // --- Funciones de Comunicación con Sistema Padre ---
    function sendToParent(eventType, data = {}) {
        if (isInIframe && window.parent) {
            console.log(`📤 Enviando evento al sistema padre: ${eventType}`, data);
            window.parent.postMessage({
                context: "h5p",
                action: "xAPI",
                statement: {
                    verb: {
                        id: `http://adlnet.gov/expapi/verbs/${eventType}`,
                        display: { "en-US": eventType }
                    },
                    object: {
                        id: XAPI_CONFIG.activityId,
                        definition: {
                            name: { "en-US": XAPI_CONFIG.activityName },
                            description: { "en-US": XAPI_CONFIG.activityDescription }
                        }
                    },
                    result: data
                }
            }, "*");
        }
    }

    function sendH5PEvent(eventType) {
        if (isInIframe && window.parent) {
            console.log(`📤 Enviando evento H5P: ${eventType}`);
            window.parent.postMessage({
                type: `H5P_${eventType}`,
                context: "h5p"
            }, "*");
        }
    }


    function initGame() {
        secretCode = []; currentGuess = []; currentRowIndex = 0;
        attemptsCount = 0;
        messageArea.textContent = '';
        messageArea.style.color = '';
        guessBtn.disabled = false;
        clearBtn.disabled = false;
        guessBtn.style.display = '';
        clearBtn.style.display = '';
        guessBtn.textContent = "Probar";
        // Removido onclick para evitar duplicación con addEventListener

        console.log('🎮 Inicializando juego...');
        console.log('🔘 Botón Probar configurado:', {
            disabled: guessBtn.disabled,
            textContent: guessBtn.textContent,
            onclick: 'removido (usando addEventListener)'
        });

        cracksOverlay.classList.remove('visible');

        // Registrar inicio del juego en XAPI
        gameStartTime = new Date();
        if (isInIframe) {
            sendToParent('initialized');
            sendH5PEvent('STARTED');
            console.log('🎮 Juego iniciado - Eventos enviados al sistema padre');
        } else if (xapiManager && typeof xapiManager.gameStarted === 'function') {
            xapiManager.gameStarted();
            console.log('🎮 Juego iniciado - Evento XAPI disparado');
        }

        const availableRunes = [...RUNES];
        for (let i = 0; i < CODE_LENGTH; i++) {
            const randomIndex = Math.floor(Math.random() * availableRunes.length);
            secretCode.push(availableRunes.splice(randomIndex, 1)[0]);
        }
        
        guessesContainer.innerHTML = '';
        createGuessingRows();
        createRunePalette();
        updateActiveRow();
        updatePaletteState();
    }
    
    function createGuessingRows() {
        for (let i = 0; i < MAX_GUESSES; i++) {
            const row = document.createElement('div');
            row.className = 'flex items-center justify-center space-x-1';
            row.dataset.rowIndex = i;
            
            const guessSlotsHTML = Array.from({ length: CODE_LENGTH }, () => `<div class="guess-slot"></div>`).join('');
            const feedbackHTML = `<div class="grid grid-cols-2 gap-0.5 ml-2">${Array.from({ length: CODE_LENGTH }, () => `<div class="feedback-peg peg-empty"></div>`).join('')}</div>`;
            
            row.innerHTML = `<div class="flex space-x-1">${guessSlotsHTML}</div>${feedbackHTML}`;
            guessesContainer.appendChild(row);
        }
    }

    function createRunePalette() {
        runePalette.innerHTML = '';
        RUNES.forEach(runeSVG => {
            const btn = document.createElement('button');
            btn.className = 'rune-btn';
            btn.innerHTML = runeSVG;
            btn.dataset.rune = runeSVG;
            btn.addEventListener('click', () => addRuneToGuess(runeSVG));
            runePalette.appendChild(btn);
        });
    }

    function updatePaletteState() {
        console.log(`🎨 Actualizando estado de la paleta. Combinación actual: ${currentGuess.length} runas`);
        const paletteButtons = runePalette.querySelectorAll('[data-rune]');
        console.log(`🎨 Encontrados ${paletteButtons.length} botones de runas`);
        
        paletteButtons.forEach(btn => {
            btn.disabled = currentGuess.includes(btn.dataset.rune);
        });
        
        const enabledButtons = paletteButtons.length - currentGuess.length;
        console.log(`🎨 Paleta actualizada. Botones habilitados: ${enabledButtons}`);
    }

    function addRuneToGuess(runeSVG) {
        if (currentGuess.length < CODE_LENGTH) {
            currentGuess.push(runeSVG);
            updateCurrentGuessDisplay();
            updatePaletteState();
        }
    }

    function clearCurrentGuess() {
        currentGuess = [];
        updateCurrentGuessDisplay();
        updatePaletteState();
    }

    function updateCurrentGuessDisplay() {
        const activeRow = guessesContainer.querySelector(`[data-row-index='${currentRowIndex}']`);
        if (!activeRow) return;
        const slots = activeRow.querySelectorAll('.guess-slot');
        slots.forEach((slot, index) => {
            slot.innerHTML = currentGuess[index] || '';
            slot.classList.toggle('filled', !!currentGuess[index]);
        });
    }

    function handleGuess() {
        console.log('🎯 Iniciando handleGuess...');
        console.log('📊 Estado antes del intento:', {
            currentGuessLength: currentGuess.length,
            currentRowIndex: currentRowIndex,
            attemptsCount: attemptsCount
        });

        if (currentGuess.length !== CODE_LENGTH) {
            messageArea.textContent = "Elige 4 runas.";
            console.log('❌ Combinación incompleta, faltan runas');
            return;
        }
        messageArea.textContent = "";
        console.log('✅ Combinación completa, procesando...');

        attemptsCount++;
        console.log(`🔢 Intento número: ${attemptsCount}`);

        let correctPosition = 0, correctRune = 0;
        const secretCopy = [...secretCode], guessCopy = [...currentGuess];

        for (let i = guessCopy.length - 1; i >= 0; i--) {
            if (guessCopy[i] === secretCopy[i]) {
                correctPosition++;
                guessCopy.splice(i, 1);
                secretCopy.splice(i, 1);
            }
        }

        for (let i = 0; i < guessCopy.length; i++) {
            const foundIndex = secretCopy.indexOf(guessCopy[i]);
            if (foundIndex !== -1) {
                correctRune++;
                secretCopy.splice(foundIndex, 1);
            }
        }
        
        console.log(`📈 Resultado: ${correctPosition} posición correcta, ${correctRune} runa correcta`);
        displayFeedback(correctPosition, correctRune);

        // Registrar intento en XAPI
        if (isInIframe) {
            console.log('📤 Enviando evento de intento al sistema padre...');
            sendToParent('attempted', {
                score: { raw: correctPosition + correctRune, max: 4 },
                completion: false,
                success: false,
                'http://adlnet.gov/expapi/extension/guess-number': attemptsCount,
                'http://adlnet.gov/expapi/extension/correct-position': correctPosition,
                'http://adlnet.gov/expapi/extension/correct-rune': correctRune
            });
            console.log('✅ Evento de intento enviado al sistema padre');
        } else if (xapiManager && typeof xapiManager.attemptMade === 'function') {
            console.log('📤 Enviando evento XAPI...');
            try {
                xapiManager.attemptMade(attemptsCount, correctPosition, correctRune);
                console.log('✅ Evento XAPI enviado correctamente');
            } catch (error) {
                console.error('❌ Error enviando evento XAPI:', error);
            }
        } else {
            console.log('⚠️ XAPI Manager no disponible');
        }

        console.log('🔄 Verificando resultado del intento...');
        if (correctPosition === CODE_LENGTH) {
            console.log('🎉 ¡VICTORIA! Combinación correcta');
            endGame(true);
            return;
        }
        
        console.log('🔄 No es la combinación correcta, continuando...');
        console.log(`📊 Estado antes de avanzar: currentRowIndex=${currentRowIndex}, attemptsCount=${attemptsCount}`);
        
        currentRowIndex++;
        console.log(`🔄 Intento ${attemptsCount} completado. Siguiente fila: ${currentRowIndex}`);
        
        if (currentRowIndex >= MAX_GUESSES) {
            console.log('❌ Máximo de intentos alcanzado');
            endGame(false);
        } else {
            console.log('✅ Preparando siguiente intento...');
            console.log('🧹 Limpiando combinación actual...');
            currentGuess = [];
            console.log('🧹 Combinación actual limpiada');
            console.log('📍 Actualizando fila activa...');
            updateActiveRow();
            console.log('🎨 Actualizando estado de paleta...');
            updatePaletteState();
            console.log('🎯 Listo para siguiente combinación');
            console.log(`📊 Estado final: currentRowIndex=${currentRowIndex}, currentGuess.length=${currentGuess.length}`);
        }
    }

    function displayFeedback(correctPosition, correctRune) {
        console.log(`🎨 Mostrando feedback: ${correctPosition} posición correcta, ${correctRune} runa correcta`);
        const activeRow = guessesContainer.querySelector(`[data-row-index='${currentRowIndex}']`);
        if (!activeRow) {
            console.log(`❌ No se encontró la fila activa ${currentRowIndex}`);
            return;
        }
        const pegs = activeRow.querySelectorAll('.feedback-peg');
        console.log(`🎨 Encontrados ${pegs.length} pegs para actualizar`);
        pegs.forEach((peg, index) => {
            peg.className = 'feedback-peg';
            if(index < correctPosition) peg.classList.add('peg-correct');
            else if (index < correctPosition + correctRune) peg.classList.add('peg-present');
            else peg.classList.add('peg-empty');
        });
        console.log('✅ Feedback mostrado correctamente');
    }

    function endGame(isWin) {
        // Ocultar botones de control al finalizar
        guessBtn.style.display = 'none';
        clearBtn.style.display = 'none';
        
        // Deshabilitar paleta de runas
        runePalette.querySelectorAll('[data-rune]').forEach(btn => btn.disabled = true);

        console.log('🎮 Juego finalizado - Botones de control ocultados');

        // Calcular tiempo transcurrido
        gameEndTime = new Date();
        const timeSpent = gameEndTime - gameStartTime;
        const timeSpentISO = `PT${Math.floor(timeSpent / 1000)}S`;

        if (isWin) {
            messageArea.textContent = "¡Combinación correcta!";
            messageArea.style.color = '#86efac';
            winSound.play().catch(e => console.log("No se pudo reproducir el sonido de victoria."));
            triggerConfetti();
            
            // Registrar victoria en XAPI
            if (isInIframe) {
                console.log('📤 Enviando evento de victoria al sistema padre...');
                sendToParent('passed', {
                    score: { raw: 100, max: 100 },
                    completion: true,
                    success: true,
                    'http://adlnet.gov/expapi/extension/attempts': attemptsCount,
                    'http://adlnet.gov/expapi/extension/time-spent': timeSpentISO
                });
                sendH5PEvent('PASSED');
                console.log('✅ Evento de victoria enviado al sistema padre');
            } else if (xapiManager && typeof xapiManager.gamePassed === 'function') {
                xapiManager.gamePassed(attemptsCount, timeSpentISO);
                console.log('Victoria registrada - Evento XAPI PASSED disparado');
            }
        } else {
            messageArea.textContent = "Has fallado.";
            messageArea.style.color = '#f87171';
            loseSound.play().catch(e => console.log("No se pudo reproducir el sonido de derrota."));
            triggerExplosion();
            
            console.log('⏳ Esperando 2 segundos antes de enviar evento de derrota para permitir ver la combinación...');
            
            // Registrar derrota en XAPI con delay para permitir ver la combinación
            setTimeout(() => {
                if (isInIframe) {
                    console.log('📤 Enviando evento de derrota al sistema padre (después de delay)...');
                    sendToParent('failed', {
                        score: { raw: 0, max: 100 },
                        completion: true,
                        success: false,
                        'http://adlnet.gov/expapi/extension/time-spent': timeSpentISO
                    });
                    sendH5PEvent('FAILED');
                    console.log('✅ Evento de derrota enviado al sistema padre');
                } else if (xapiManager && typeof xapiManager.gameFailed === 'function') {
                    xapiManager.gameFailed(timeSpentISO);
                    console.log('Derrota registrada - Evento XAPI FAILED disparado');
                }
            }, 2000); // Delay de 2 segundos
            
            setTimeout(() => {
                console.log('🔍 Mostrando combinación correcta...');
                const secretDisplay = document.createElement('div');
                secretDisplay.className = 'flex justify-center space-x-1 mt-2';
                secretDisplay.innerHTML = secretCode.map(rune => `<div class="guess-slot revealed-slot">${rune}</div>`).join('');
                guessesContainer.appendChild(secretDisplay);
                console.log('✅ Combinación correcta mostrada');
            }, 820);
        }

        // Registrar finalización del juego
        if (isInIframe) {
            console.log('📤 Enviando evento de finalización al sistema padre...');
            sendToParent('completed', {
                score: { raw: isWin ? 100 : 0, max: 100 },
                completion: true,
                success: isWin,
                'http://adlnet.gov/expapi/extension/time-spent': timeSpentISO
            });
            sendH5PEvent('COMPLETED');
            console.log('✅ Evento de finalización enviado al sistema padre');
        } else if (xapiManager && typeof xapiManager.gameCompleted === 'function') {
            xapiManager.gameCompleted(isWin, timeSpentISO);
            console.log('Finalización registrada - Evento XAPI COMPLETED disparado');
        }

        console.log('🎮 Actividad completada. Para volver a jugar, recarga la página.');
    }
    
    // --- Funciones de Animación ---
    function triggerConfetti() {
        const duration = 3 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 100 };

        function randomInRange(min, max) { return Math.random() * (max - min) + min; }

        const interval = setInterval(function() {
            const timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) return clearInterval(interval);
            
            const particleCount = 50 * (timeLeft / duration);
            confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
            confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
        }, 250);
    }

    function triggerExplosion() {
        mainContainer.classList.add('shake');
        cracksOverlay.classList.add('visible');

        const flash = document.createElement('div');
        flash.className = 'explosion-flash';
        document.body.appendChild(flash);

        setTimeout(() => {
            mainContainer.classList.remove('shake');
            if (document.body.contains(flash)) {
                document.body.removeChild(flash);
            }
        }, 820);
    }

    function updateActiveRow() {
        console.log(`📍 Actualizando fila activa: ${currentRowIndex}`);
        const allRows = document.querySelectorAll('[data-row-index]');
        console.log(`📍 Encontradas ${allRows.length} filas en total`);
        
        allRows.forEach(row => {
            row.style.backgroundColor = 'transparent';
        });
        
        const activeRow = guessesContainer.querySelector(`[data-row-index='${currentRowIndex}']`);
        if (activeRow) {
            activeRow.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
            console.log(`✅ Fila ${currentRowIndex} activada correctamente`);
        } else {
            console.log(`❌ No se encontró la fila ${currentRowIndex}`);
            console.log(`❌ Filas disponibles:`, Array.from(allRows).map(row => row.dataset.rowIndex));
        }
    }

    // --- Arranque del Juego ---
    initGame();
    clearBtn.addEventListener('click', clearCurrentGuess);
    
    // Verificar estado del botón antes de agregar el listener
    console.log('🔘 Estado del botón Probar:', {
        disabled: guessBtn.disabled,
        textContent: guessBtn.textContent,
        onclick: 'removido (usando addEventListener)'
    });
    
    guessBtn.addEventListener('click', function(event) {
        console.log('🖱️ Click en botón Probar detectado');
        console.log('🔘 Estado del botón en el click:', {
            disabled: guessBtn.disabled,
            textContent: guessBtn.textContent
        });
        handleGuess();
    });
    
    console.log('✅ Event listeners agregados correctamente');

    // Funciones de prueba para debugging
    window.debugGame = function() {
        console.log('🔍 Estado actual del juego:');
        console.log('- currentRowIndex:', currentRowIndex);
        console.log('- currentGuess:', currentGuess);
        console.log('- attemptsCount:', attemptsCount);
        console.log('- secretCode:', secretCode);
        console.log('- MAX_GUESSES:', MAX_GUESSES);
    };

    window.testNextAttempt = function() {
        console.log('🧪 Simulando siguiente intento...');
        currentGuess = [];
        updateActiveRow();
        updatePaletteState();
    };

    window.testClickProbar = function() {
        console.log('🧪 Simulando click en botón Probar...');
        console.log('🔘 Estado actual del botón:', {
            disabled: guessBtn.disabled,
            textContent: guessBtn.textContent,
            onclick: 'removido (usando addEventListener)'
        });
        handleGuess();
    };

    window.forceNextAttempt = function() {
        console.log('🧪 Forzando siguiente intento...');
        console.log('📊 Estado actual:', {
            currentRowIndex: currentRowIndex,
            attemptsCount: attemptsCount,
            currentGuessLength: currentGuess.length
        });
        
        currentRowIndex++;
        console.log(`🔄 Avanzando a fila: ${currentRowIndex}`);
        
        currentGuess = [];
        console.log('🧹 Combinación limpiada');
        
        updateActiveRow();
        updatePaletteState();
        console.log('🎯 Siguiente intento preparado');
    };

    window.debugCurrentState = function() {
        console.log('🔍 Estado actual del juego:');
        console.log('- currentRowIndex:', currentRowIndex);
        console.log('- attemptsCount:', attemptsCount);
        console.log('- currentGuess:', currentGuess);
        console.log('- currentGuess.length:', currentGuess.length);
        console.log('- secretCode:', secretCode);
        console.log('- MAX_GUESSES:', MAX_GUESSES);
        console.log('- isInIframe:', isInIframe);
        
        const allRows = document.querySelectorAll('[data-row-index]');
        console.log('- Filas disponibles:', Array.from(allRows).map(row => row.dataset.rowIndex));
        
        const paletteButtons = runePalette.querySelectorAll('[data-rune]');
        console.log('- Botones de paleta:', paletteButtons.length);
    };
});
</script>
</body>
</html>
