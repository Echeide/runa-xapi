<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misterio en la Máquina de Escribir</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Sistema XAPI para H5P -->
    <script src="XAPI_samples/h5p-xapi-events.js"></script>
    <script src="h5p-xapi-manager.js"></script>
    <style>
        :root {
            --bg-color: #6d5a49; /* Madera oscura */
            --paper-color: #f1e9d6;
            --text-color: #3a3a3a;
            --primary-color: #8b0000; /* Rojo oscuro */
            --key-bg: #e0e0e0;
            --key-border: #a0a0a0;
            --key-text: #2a2a2a;
            --disabled-key-bg: #b0b0b0;
            --accent-color: #d4a373; /* Tono ocre/dorado */
            --success-color: #5a7d3a; /* Verde musgo */
        }

        body {
            font-family: 'Special Elite', monospace;
            background-color: var(--bg-color);
            
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-align: center;
            padding: 10px;
        }

        #typewriter-container {
            position: relative;
            background-color: #4a4a4a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: inset 0 0 10px #222, 0 10px 20px #000;
            width: 95%;
            max-width: 700px;
        }

        #paper {
            background-color: var(--paper-color);
            background-image: url('https://www.transparenttextures.com/patterns/crissxcross.png');
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            padding: 20px;
            margin: -50px auto 20px auto;
            border-radius: 3px;
            min-height: 120px;
        }
        
        #mistakes-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            min-height: 40px;
        }

        .mistake-x {
            font-size: 2.5em;
            font-weight: bold;
            color: transparent;
            -webkit-text-stroke: 2px var(--accent-color);
            text-stroke: 2px var(--accent-color);
            transition: all 0.3s;
        }

        .mistake-x.filled {
            color: var(--primary-color);
            -webkit-text-stroke: 2px var(--primary-color);
            text-stroke: 2px var(--primary-color);
        }

        #word-display {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 40px;
        }
        
        .letter-placeholder {
            min-width: 30px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            font-size: 2.5em;
            text-transform: uppercase;
            border-bottom: 3px solid var(--text-color);
            padding-bottom: 5px;
        }

        .letter-placeholder.space {
            border-bottom-color: transparent;
        }

        #keyboard-container {
            display: grid;
            grid-template-columns: repeat(10, 1fr); 
            gap: 8px;
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
        }

        .key {
            aspect-ratio: 1 / 1;
            font-family: inherit;
            font-size: 1.5em;
            color: var(--key-text);
            background-color: var(--key-bg);
            border: 2px solid var(--key-border);
            border-bottom-width: 5px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.07s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .key:active:not(:disabled) {
            transform: translateY(3px);
            border-bottom-width: 2px;
        }
        .key:disabled {
            background-color: var(--disabled-key-bg);
            color: #777;
            cursor: not-allowed;
        }

        #result-container {
            margin-top: 20px;
            min-height: 50px;
        }
        
        #result-display {
            font-size: 1.8em;
        }

        #restart-button {
            display: none;
            font-family: inherit;
            font-size: 1.2em;
            padding: 10px 20px;
            color: var(--paper-color);
            background-color: var(--primary-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        #flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primary-color);
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
        }

        #flash-overlay.flash {
            animation: red-flash 0.4s ease-out;
        }

        @keyframes red-flash {
            0% { opacity: 0.6; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="flash-overlay"></div>
    <div id="typewriter-container">
        <div id="paper">
            <div id="mistakes-container"></div>
            <div id="word-display"></div>
        </div>
        <div id="keyboard-container"></div>
        <div id="result-container">
            <div id="result-display"></div>
            <button id="restart-button">Nuevo Manuscrito</button>
        </div>
    </div>

    <script>
    // Detectar idioma desde URL o usar español por defecto
    const urlParams = new URLSearchParams(window.location.search);
    const lang = ['es', 'en', 'de'].includes(urlParams.get('lang')) ? urlParams.get('lang') : 'es';
    console.log('🌐 Idioma detectado:', lang);

    // Traducciones
    const translations = {
        es: {
            title: "Misterio en la Máquina de Escribir",
            activityName: "Misterio en la Máquina de Escribir",
            activityDescription: "Juego de ahorcado temático de misterio con títulos de obras de Agatha Christie",
            winMessage: "Misterio Resuelto",
            loseMessage: "Manuscrito Inacabado",
            restartButton: "Nuevo Manuscrito",
            alphabet: "QWERTYUIOPASDFGHJKLÑZXCVBNM",
            wordList: [
                "MUERTE EN EL NILO", "DIEZ NEGRITOS", "ASESINATO EN EL ORIENT EXPRESS",
                "EL MISTERIOSO CASO DE STYLES", "EL ASESINATO DE ROGER ACKROYD", "CITA CON LA MUERTE",
                "UN CADAVER EN LA BIBLIOTECA", "MALDAD BAJO EL SOL", "CINCO CERDITOS", "EL TREN DE LAS 4 50",
                "ASESINATO EN MESOPOTAMIA", "LA CASA TORCIDA", "EL ESPEJO SE ROMPIO", "NEMESIS",
                "TERCERA MUCHACHA", "HACIA CERO", "EL MISTERIO DE LAS SIETE ESFERAS"
            ]
        },
        en: {
            title: "Mystery at the Typewriter",
            activityName: "Mystery at the Typewriter",
            activityDescription: "Hangman game themed around Agatha Christie's mystery novels",
            winMessage: "Mystery Solved",
            loseMessage: "Manuscript Unfinished",
            restartButton: "New Manuscript",
            alphabet: "QWERTYUIOPASDFGHJKLZXCVBNM",
            wordList: [
                "DEATH ON THE NILE", "AND THEN THERE WERE NONE", "MURDER ON THE ORIENT EXPRESS",
                "THE MYSTERIOUS AFFAIR AT STYLES", "THE MURDER OF ROGER ACKROYD", "APPOINTMENT WITH DEATH",
                "THE BODY IN THE LIBRARY", "EVIL UNDER THE SUN", "FIVE LITTLE PIGS", "FOUR FIFTY FROM PADDINGTON",
                "MURDER IN MESOPOTAMIA", "CROOKED HOUSE", "THE MIRROR CRACKD", "NEMESIS",
                "THIRD GIRL", "TOWARDS ZERO", "THE SEVEN DIALS MYSTERY"
            ]
        },
        de: {
            title: "Mysterium an der Schreibmaschine",
            activityName: "Mysterium an der Schreibmaschine",
            activityDescription: "Galgenmännchen-Spiel mit Titeln von Agatha Christies Kriminalromanen",
            winMessage: "Mysterium Gelöst",
            loseMessage: "Manuskript Unvollendet",
            restartButton: "Neues Manuskript",
            alphabet: "QWERTZUIOPASDFGHJKLYXCVBNM",
            wordList: [
                "DER TOD AUF DEM NIL", "ZEHN KLEINE NEGERLEIN", "MORD IM ORIENT EXPRESS",
                "DAS FEHLENDE GLIED IN DER KETTE", "ALIBI", "RENDEZVOUS MIT EINER LEICHE",
                "DIE TOTE IN DER BIBLIOTHEK", "DAS BOESE UNTER DER SONNE", "FUENF KLEINE SCHWEINE", "SECHZEHN UHR FUENFZIG AB PADDINGTON",
                "MORD IN MESOPOTAMIEN", "DAS KRUMME HAUS", "SECHZEHN UHR FUENFZIG AB PADDINGTON", "NEMESIS",
                "DAS DRITTE MAEDCHEN", "Das ENDE KOMMT NIE", "DIE SIEBEN ZIFFERBLAETTER"
            ]
        }
    };

    const t = translations[lang];

    // Actualizar título del documento
    document.title = t.title;

    const wordDisplay = document.getElementById('word-display');
    const keyboardContainer = document.getElementById('keyboard-container');
    const resultDisplay = document.getElementById('result-display');
    const restartButton = document.getElementById('restart-button');
    const mistakesContainer = document.getElementById('mistakes-container');
    const flashOverlay = document.getElementById('flash-overlay');

    // Actualizar texto del botón
    restartButton.textContent = t.restartButton;

    const wordList = t.wordList;
    const alphabet = t.alphabet;
    const MAX_MISTAKES = 6;

    let secretWord = '';
    let guessedLetters = [];
    let mistakes = 0;
    let soundSynth;
    let xapiManager = null;
    let gameStartTime = Date.now();

    try {
        soundSynth = new Tone.PluckSynth().toDestination();
    } catch (e) {
        console.error("Tone.js no pudo inicializarse.", e);
        soundSynth = null;
    }

    // Detectar si estamos en un iframe
    const isInIframe = window.parent !== window;
    console.log('🔍 Detectado iframe:', isInIframe);

    // Inicializar XAPI Manager solo si NO estamos en iframe
    if (!isInIframe) {
        try {
            xapiManager = new H5PXAPIManager({
                activityId: 'urn:uuid:ahorcado-misterio-maquina-escribir',
                activityName: t.activityName,
                activityDescription: t.activityDescription
            });
            console.log('✅ XAPI Manager inicializado correctamente');
        } catch (e) {
            console.warn('⚠️ XAPI Manager no pudo inicializarse:', e);
            xapiManager = null;
        }
    }

    // Funciones de comunicación con el sistema padre (cuando está en iframe)
    function sendToParent(eventType, data = {}) {
        if (isInIframe && window.parent) {
            console.log(`📤 Enviando evento al sistema padre: ${eventType}`, data);
            window.parent.postMessage({
                context: "h5p",
                action: "xAPI",
                statement: {
                    verb: {
                        id: `http://adlnet.gov/expapi/verbs/${eventType}`,
                        display: { "en-US": eventType }
                    },
                    result: data.result || {},
                    ...data
                }
            }, "*");
        }
    }

    function sendH5PEvent(eventType) {
        if (isInIframe && window.parent) {
            console.log(`📤 Enviando evento H5P: ${eventType}`);
            window.parent.postMessage({
                type: `H5P_${eventType}`,
                context: "h5p"
            }, "*");
        }
    }

    function initGame() {
        secretWord = wordList[Math.floor(Math.random() * wordList.length)];
        guessedLetters = [];
        mistakes = 0;
        gameStartTime = Date.now();
        
        resultDisplay.textContent = '';
        restartButton.style.display = 'none';
        
        renderMistakes();
        renderWordDisplay();
        renderKeyboard();
        
        // Disparar evento XAPI de inicio
        if (isInIframe) {
            sendToParent('initialized');
            sendH5PEvent('STARTED');
            console.log('🎮 Juego iniciado - Eventos enviados al sistema padre');
        } else if (xapiManager) {
            try {
                xapiManager.gameStarted();
                console.log('📤 Evento XAPI: Juego iniciado');
            } catch (e) {
                console.warn('⚠️ Error al enviar evento XAPI de inicio:', e);
            }
        }
    }
    
    function renderMistakes() {
        mistakesContainer.innerHTML = '';
        for (let i = 0; i < MAX_MISTAKES; i++) {
            const x = document.createElement('div');
            x.textContent = 'X';
            x.classList.add('mistake-x');
            if (i < mistakes) {
                x.classList.add('filled');
            }
            mistakesContainer.appendChild(x);
        }
    }

    function renderWordDisplay() {
        wordDisplay.innerHTML = '';
        for (const char of secretWord) {
            const placeholder = document.createElement('div');
            placeholder.classList.add('letter-placeholder');
            if (char === ' ') {
                placeholder.classList.add('space');
                guessedLetters.push(' ');
            } else if (guessedLetters.includes(char)) {
                placeholder.textContent = char;
            }
            wordDisplay.appendChild(placeholder);
        }
    }
    
    function renderKeyboard() {
        keyboardContainer.innerHTML = '';
        for (const letter of alphabet) {
            const key = document.createElement('button');
            key.classList.add('key');
            key.textContent = letter;
            key.addEventListener('click', () => handleGuess(letter));
            keyboardContainer.appendChild(key);
        }
    }

    function playTypeSound() {
        if (soundSynth && Tone.context.state === 'running') {
            soundSynth.triggerAttackRelease("C4", "8n");
        }
    }
    
    function triggerFlash() {
        flashOverlay.classList.remove('flash'); // Quita por si acaso estaba
        void flashOverlay.offsetWidth; // Truco para forzar el reinicio de la animación
        flashOverlay.classList.add('flash');
    }

    function handleGuess(letter) {
        if (Tone.context.state !== 'running') {
            Tone.context.resume();
        }
        playTypeSound();

        if (guessedLetters.includes(letter) || mistakes >= MAX_MISTAKES) return;

        guessedLetters.push(letter);
        
        const key = Array.from(keyboardContainer.children).find(k => k.textContent === letter);
        if(key) key.disabled = true;

        const isCorrect = secretWord.includes(letter);

        if (isCorrect) {
            renderWordDisplay();
            checkWin();
        } else {
            mistakes++;
            triggerFlash();
            renderMistakes();
            checkLoss();
        }
        
        // Disparar evento XAPI de intento
        if (isInIframe) {
            sendToParent('attempted', {
                result: {
                    score: { raw: isCorrect ? 1 : 0, max: 1 },
                    completion: false,
                    success: false
                }
            });
            console.log('📤 Evento XAPI: Intento registrado (letra:', letter, ', correcto:', isCorrect, ')');
        } else if (xapiManager) {
            try {
                xapiManager.attemptMade(
                    guessedLetters.length, 
                    isCorrect ? 1 : 0, 
                    isCorrect ? 1 : 0
                );
                console.log('📤 Evento XAPI: Intento registrado (letra:', letter, ', correcto:', isCorrect, ')');
            } catch (e) {
                console.warn('⚠️ Error al enviar evento XAPI de intento:', e);
            }
        }
    }
    
    function checkWin() {
        const allGuessed = secretWord.split('').every(char => guessedLetters.includes(char));
        if (allGuessed) {
            resultDisplay.textContent = t.winMessage;
            resultDisplay.style.color = "var(--success-color)";
            
            // Disparar evento XAPI de victoria
            if (isInIframe) {
                console.log('📤 Enviando evento de victoria al sistema padre...');
                sendToParent('passed', {
                    result: {
                        score: { raw: 100, max: 100 },
                        completion: true,
                        success: true
                    }
                });
                sendH5PEvent('PASSED');
                sendToParent('completed', {
                    result: {
                        score: { raw: 100, max: 100 },
                        completion: true,
                        success: true
                    }
                });
                sendH5PEvent('COMPLETED');
                console.log('✅ Evento de victoria enviado');
            } else if (xapiManager) {
                try {
                    const timeSpent = (Date.now() - gameStartTime) / 1000; // en segundos
                    xapiManager.gamePassed(guessedLetters.length, timeSpent);
                    xapiManager.gameCompleted(true, timeSpent);
                    console.log('📤 Evento XAPI: Juego completado con éxito (intentos:', guessedLetters.length, ', tiempo:', timeSpent, 's)');
                } catch (e) {
                    console.warn('⚠️ Error al enviar evento XAPI de victoria:', e);
                }
            }
            
            endGame();
        }
    }

    function checkLoss() {
        if (mistakes >= MAX_MISTAKES) {
            resultDisplay.textContent = t.loseMessage;
            resultDisplay.style.color = "var(--accent-color)";
            guessedLetters = [...secretWord];
            renderWordDisplay();
            
            // Disparar evento XAPI de derrota con delay
            setTimeout(() => {
                if (isInIframe) {
                    console.log('📤 Enviando evento de derrota al sistema padre...');
                    sendToParent('failed', {
                        result: {
                            score: { raw: 0, max: 100 },
                            completion: true,
                            success: false
                        }
                    });
                    sendH5PEvent('FAILED');
                    sendToParent('completed', {
                        result: {
                            score: { raw: 0, max: 100 },
                            completion: true,
                            success: false
                        }
                    });
                    sendH5PEvent('COMPLETED');
                    console.log('❌ Evento de derrota enviado');
                } else if (xapiManager) {
                    try {
                        const timeSpent = (Date.now() - gameStartTime) / 1000; // en segundos
                        xapiManager.gameFailed(timeSpent);
                        xapiManager.gameCompleted(false, timeSpent);
                        console.log('📤 Evento XAPI: Juego fallido (intentos:', guessedLetters.length, ', tiempo:', timeSpent, 's)');
                    } catch (e) {
                        console.warn('⚠️ Error al enviar evento XAPI de derrota:', e);
                    }
                }
            }, 500);
            
            endGame();
        }
    }
    
    function endGame() {
        Array.from(keyboardContainer.children).forEach(key => key.disabled = true);
        // No mostrar botón de reinicio en contexto de actividad XAPI
        // restartButton.style.display = 'block';
    }

    restartButton.addEventListener('click', initGame);
    initGame();
    </script>
</body>
</html>
